package org.kompiro.jamcircle.web;import static java.lang.String.format;import java.util.Arrays;import java.util.Collection;import org.eclipse.core.runtime.*;import org.eclipse.core.runtime.jobs.Job;import org.kompiro.jamcircle.kanban.model.*;import org.kompiro.jamcircle.web.figure.CardFigure;import org.kompiro.jamcircle.web.figure.LaneFigure;import org.vaadin.artur.icepush.ICEPush;import com.vaadin.Application;import com.vaadin.data.util.BeanItemContainer;import com.vaadin.event.ItemClickEvent;import com.vaadin.event.ItemClickEvent.ItemClickListener;import com.vaadin.terminal.ClassResource;import com.vaadin.terminal.Resource;import com.vaadin.ui.*;public class JAMCircleWebApplication extends Application {	private static final long serialVersionUID = 1L;	private ICEPush push = new ICEPush();	private WebContext context;	private Window mainWindow;	private Table boardSelection;	private Board board;	private AbsoluteLayout boardLayout;	@SuppressWarnings("serial")	@Override	public void init() {		context = WebContext.getDefault();		initMain();		initLeft();		final Panel boardPanel = new Panel();		boardPanel.setCaption("board body");		boardLayout = new AbsoluteLayout();		boardLayout.setWidth("1000px");		boardLayout.setHeight("1000px");		boardPanel.setContent(boardLayout);		boardSelection.addListener(new ItemClickListener() {			@Override			public void itemClick(ItemClickEvent event) {				board = getBoard(event);				load(boardPanel);				String message = "'%s' is opened.";				mainWindow.showNotification(format(message, board.getTitle()));			}			private Board getBoard(ItemClickEvent event) {				return (Board) event.getItemId();			}		});		mainWindow.addComponent(boardPanel);		// final Tree tree = new Tree("Board");		// boardSelection.addListener(new ItemClickListener() {		//		// @Override		// public void itemClick(ItemClickEvent event) {		// BoardHierarchy newDataSource = new BoardHierarchy(getBoard(event));		// tree.setContainerDataSource(newDataSource);		// }		//		// private Board getBoard(ItemClickEvent event) {		// return (Board) event.getItemId();		// }		// });		// tree.setItemCaptionMode(AbstractSelect.ITEM_CAPTION_MODE_PROPERTY);		// tree.setItemCaptionPropertyId("caption");		// mainWindow.addComponent(tree);		Job job = new Job("test") {			protected IStatus run(IProgressMonitor monitor) {				boardLayout.removeAllComponents();				boardLayout.requestRepaintAll();				load(boardPanel);				push.push();				mainWindow.showNotification("modified");				schedule(60000L);				return Status.OK_STATUS;			};		};		job.schedule(2000L);	}	private void load(final Panel boardPanel) {		boardLayout = new AbsoluteLayout();		boardLayout.setWidth("1000px");		boardLayout.setHeight("1000px");		boardPanel.setContent(boardLayout);		if (board == null)			return;		context.getKanbanService().flushBoard(board);		Lane[] lanes = board.getLanes();		for (Lane lane : lanes) {			LaneFigure laneFigure = createLaneFigure(lane);			boardLayout.addComponent(laneFigure.getPanel(), laneFigure.getLocation());			Card[] cards = lane.getCards();			for (Card card : cards) {				createCardFigure(laneFigure.getLayout(), card);			}		}		Card[] cards = board.getCards();		for (Card card : cards) {			createCardFigure(boardLayout, card);		}	}	private LaneFigure createLaneFigure(Lane lane) {		LaneFigure figure = new LaneFigure(lane);		return figure;	}	private CardFigure createCardFigure(AbsoluteLayout layout, Card card) {		CardFigure figure = new CardFigure(layout, card);		return figure;	}	private void initLeft() {		boardSelection = new Table("Boards");		Resource icon = new ClassResource("icons/kanban.gif", this);		boardSelection.setIcon(icon);		boardSelection.setSelectable(true);		mainWindow.addComponent(push);		mainWindow.addComponent(boardSelection);		Board[] boards = context.getKanbanService().findAllBoard();		BeanItemContainer<Board> boardSource = new BeanItemContainer<Board>(Board.class) {			private static final long serialVersionUID = 1L;			@Override			public Collection<String> getContainerPropertyIds() {				return Arrays.asList(new String[] { "title" });			}		};		boardSelection.setContainerDataSource(boardSource);		for (Board board : boards) {			boardSource.addBean(board);		}		setMainWindow(mainWindow);	}	private void initMain() {		mainWindow = new Window("JAM Circle");		Resource icon = new ClassResource("icons/kanban.gif", this);		mainWindow.setIcon(icon);		mainWindow.addComponent(push);		ComponentContainer content = new HorizontalLayout();		mainWindow.setContent(content);	}}